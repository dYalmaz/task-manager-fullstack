@page "/"
@inject HttpClient Http

<h1>My Java-Powered Tasks</h1>

@if (tasks == null)
{
    <p><em>Loading tasks from Java API...</em></p>
}
else
{

    <div class="card p-3 mb-4 shadow-sm">
        <h5 class="card-title">Add New Task</h5>
        <div class="row g-2">
            <div class="col-md-5">
                <input @bind="newTask.Title" class="form-control" placeholder="Task Title (Required)" />
            </div>
            <div class="col-md-5">
                <input @bind="newTask.Description" class="form-control" placeholder="Description" />
            </div>
            <div class="col-md-2">
                <button class="btn btn-success w-100" @onclick="AddTask">
                    Add Task
                </button>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-end mb-3">
        <button class="btn btn-secondary btn-sm" @onclick="ToggleCompleted">
            @(showCompleted ? "Hide Completed" : "Show Completed")
        </button>
    </div>

    <div class="task-sections">
        @{
            var visibleTasks = tasks?.Where(t => showCompleted || t.Status != "DONE").ToList() ?? new List<TaskItem>();
            
            var activeTasks = visibleTasks.Where(t => t.Status != "DONE").ToList();
            var completedTasks = visibleTasks.Where(t => t.Status == "DONE").ToList();
        }

        <h6 class="text-uppercase text-muted fw-bold mb-3">Active Tasks (@activeTasks.Count)</h6>
        <ul class="list-group mb-5">
            @for (int i = 0; i < activeTasks.Count; i++)
            {
                var task = activeTasks[i];
                int index = i;
                <li class="list-group-item d-flex justify-content-between align-items-center shadow-sm mb-2 rounded">
                    @RenderTaskItem(activeTasks, task, index)
                </li>
            }
        </ul>

        @if (completedTasks.Any())
        {
            <div class="d-flex align-items-center my-4">
                <hr class="flex-grow-1">
                <span class="mx-3 text-muted fw-bold">COMPLETED (@completedTasks.Count)</span>
                <hr class="flex-grow-1">
            </div>

            <ul class="list-group opacity-75">
                @for (int i = 0; i < completedTasks.Count; i++)
                {
                    var task = completedTasks[i];
                    int index = i;
                    <li class="list-group-item d-flex justify-content-between align-items-center bg-light mb-1 rounded">
                        @RenderTaskItem(completedTasks, task, index)
                    </li>
                }
            </ul>
        }
    </div>
}

@code {
    private List<TaskItem>? tasks;
    private TaskItem newTask = new TaskItem { Status = "TODO" };

    protected override async Task OnInitializedAsync()
    {
        await LoadTasks();
    }

    private async Task LoadTasks()
    {
        try 
        {
            tasks = await Http.GetFromJsonAsync<List<TaskItem>>("http://localhost:8080/api/tasks");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching tasks: {ex.Message}");
        }
    }

    private async Task AddTask()
    {
        // basic validation
        if (string.IsNullOrWhiteSpace(newTask.Title)) return;

        int maxOrder = tasks != null && tasks.Any() ? tasks.Max(t => t.SortOrder) : -1;
        newTask.SortOrder = maxOrder + 1;

        // send the POST request to the Java API
        var response = await Http.PostAsJsonAsync("http://localhost:8080/api/tasks", newTask);

        if (response.IsSuccessStatusCode)
        {
            newTask = new TaskItem { Status = "TODO" }; 
            await LoadTasks(); 
        }
    }

    private async Task DeleteTask(long id)
    {
        var response = await Http.DeleteAsync($"http://localhost:8080/api/tasks/{id}");
        if (response.IsSuccessStatusCode)
        {
            await LoadTasks(); // Re-fetch the list to hide the deleted task
        }
    }

    private async Task MarkAsDone(TaskItem task)
    {
        // Update the status locally
        task.Status = "DONE";

        // Send the PUT request to /api/tasks/{id}
        var response = await Http.PutAsJsonAsync($"http://localhost:8080/api/tasks/{task.Id}", task);

        if (response.IsSuccessStatusCode)
        {
            await LoadTasks();
        }
    }


    private bool showCompleted = true; // By default, show everything
    private void ToggleCompleted()
    {
        showCompleted = !showCompleted;
    }


    private async Task MoveTask(List<TaskItem> list, int currentIndex, int direction)
    {
        int targetIndex = currentIndex + direction;
        if (targetIndex < 0 || targetIndex >= list.Count) return;

        var current = list[currentIndex];
        var target = list[targetIndex];

        (current.SortOrder, target.SortOrder) = (target.SortOrder, current.SortOrder);

        var task1 = Http.PutAsJsonAsync($"http://localhost:8080/api/tasks/{current.Id}", current);
        var task2 = Http.PutAsJsonAsync($"http://localhost:8080/api/tasks/{target.Id}", target);

        await Task.WhenAll(task1, task2);

        await LoadTasks(); 
    }


    RenderFragment RenderTaskItem(List<TaskItem> list, TaskItem task, int index) => __builder =>
    {
        <div class="d-flex align-items-center">
            <div class="me-3 d-flex flex-column">
                @if (index > 0)
                {
                    <button class="btn btn-link btn-sm p-0 text-decoration-none" @onclick="() => MoveTask(list, index, -1)">▲</button>
                }
                @if (index < list.Count - 1)
                {
                    <button class="btn btn-link btn-sm p-0 text-decoration-none" @onclick="() => MoveTask(list, index, 1)">▼</button>
                }
            </div>

            <div>
                <strong style='text-decoration: @(task.Status == "DONE" ? "line-through" : "none")'>@task.Title</strong>
                <p class="mb-0 small text-muted">@task.Description</p>
            </div>
        </div>

        <div>
            @if (task.Status != "DONE")
            {
                <button class="btn btn-outline-success btn-sm me-2" @onclick="() => MarkAsDone(task)">Done</button>
            }
            <button class="btn btn-danger btn-sm" @onclick="() => DeleteTask(task.Id!.Value)">Delete</button>
        </div>
    };

}